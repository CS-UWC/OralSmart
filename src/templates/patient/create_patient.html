{% extends 'base.html' %}
{% block navbar %}
    {% include "navbar2.html" %}
{% endblock %}

{% block content %}

    {% if messages %}
        {% for message in messages %}
            <div class="alert alert-warning alert-dismissible fade show auto-dismiss-alert" role="alert">
                <strong>{{ message }}</strong>
                <button type="button" class="btn btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <form id="patient-form" action="{% url 'create_patient' %}" method="POST"> 
        {% csrf_token %}

        <!--Back button and submit info-->
        <div class="d-flex justify-content-between align-items-center mb-3">
            <a href="{{ back_url }}" class="btn btn-outline-primary ms-1">
                <i class="fas fa-arrow-left"></i> Back
            </a>
        </div>

        <div class="text-center mb-4">
            <h4>
                Enter the child's details in order to start screening
            </h4>
        </div>

    
<!--Div for entering child name-->
        <div class="form-floating mb-3">
            <input type="text" class="form-control form-control-sm" id="name" name='name' placeholder="Enter Child Name" required>
            <label for="name">Enter the child's first First Name</label>
        </div>

<!--Div for entering child surname-->
        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="surname" name='surname' placeholder="Enter Child Surname" required>
            <label for="surname">Enter the child's Surname</label>
        </div>

<!--Div for choosing the child age-->
        <div class="form-floating mb-3">
            <select class="form-select" id="gender" name="gender" required>
                <option value="0">Choose Gender</option>
                <option value="0">Male</option>
                <option value="1">Female</option>
                <option value="0">Other</option> <!--rather chooses the male as the default-->
                <option value="0">Prefer Not To Say</option> <!--rather chooses the male as the default-->
            </select>
            <label for="gender">Child Gender</label>  <!-- Changed from "age" to "gender" -->
        </div>

<!--Div for choosing the child age-->
        <div class="form-floating mb-3">
            <select class="form-select" id="age" name="age" required>
                <option value="">Choose Age</option>
                <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>

                <option value="adol" disabled>7 - 12</option>
                <option value="teen" disabled>13 - 18</option>
                <option value="adul" disabled>18+</option>
            </select>
            <label for="age">Child Age</label>
        </div>
<!--Div for entering the child's parent or guardian ID-->
        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="parent_name" name="parent_name" placeholder="Enter Parent First Name" required>
            <label for="parent_name">Enter the parent's First Name</label>
        </div>

<!--Div for entering the child's parent or guardian ID-->
        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="parent_surname" name="parent_surname" placeholder="Enter Parent Surname" required>
            <label for="parent_surname">Enter the parent's Surname</label>
        </div>

<!--Div for entering the child's parent or guardian ID-->
        <div class="form-floating mb-3">
            <input type="text" class="form-control" id="parent_id" name="parent_id" placeholder="Enter Parent ID" required pattern="\d{13}" maxlength="13" title="Please enter a 13-digit South African ID number">
            <label for="parent_id">Enter the parent's South African ID Number</label>
        </div>

<!--Div for entering the child's parent or guardian contact number-->
        <div class="form-floating mb-3">
            <input type="tel" class="form-control" id="parent_contact" name="parent_contact" placeholder="Enter Parent Contact Number" required pattern="\d{10}" maxlength="10" title="Please enter a 10-digit South African contact number">
            <label for="parent_contact">Enter the parent's Contact Number</label>
        </div>
         
        <div class="d-flex justify-content-center mt-4" style="gap: 2rem;">
            <button type="button" class="btn btn-outline-primary px-4 py-2" onclick="submitAndRedirect('dietary')">Start Dietary Screening</button>
            <button type="button" class="btn btn-outline-primary px-4 py-2" onclick="submitAndRedirect('dental')">Start Dental Screening</button>
            <button type="button" class="btn btn-outline-primary px-4 py-2" onclick="submitAndRedirect('both')">Start Both Screenings</button>
        </div>

    <script>

        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                document.querySelectorAll('.auto-dismiss-alert').forEach(function(alert) {
                    var bsAlert = bootstrap.Alert.getOrCreateInstance(alert);
                    bsAlert.close();
                });
            }, 3000); //3 seconds
        });

        function submitAndRedirect(screeningType) {
            // Validate Parent ID for exactly 13 digits
            const parentIdInput = document.getElementById('parent_id');
            const parentIdValue = parentIdInput.value;
            const form = document.getElementById('patient-form');
            if (!/^\d{13}$/.test(parentIdValue)) {
                parentIdInput.setCustomValidity('Parent ID must be exactly 13 digits.');
                form.reportValidity();
                parentIdInput.setCustomValidity('');
                return;
            }
            if (form.checkValidity()) {
                // Create a hidden input to indicate the screening type
                const screeningInput = document.createElement('input');
                screeningInput.type = 'hidden';
                screeningInput.name = 'screening_type';
                screeningInput.value = screeningType;
                form.appendChild(screeningInput);
                // Submit the form
                form.submit();
            } else {
                // Show validation errors
                form.reportValidity();
            }
        }
    </script>

{% endblock %}